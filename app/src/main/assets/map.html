<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Mapa con Ruta Manual</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <!-- Leaflet y Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        #toggle-routing-instructions {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #3388ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: none;
        }
        .leaflet-routing-container {
            top: 60px !important;
        }
        .popup-actions {
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
        }
        .popup-actions button {
            font-size: 12px;
            padding: 4px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-info {
            background-color: #3388ff;
            color: white;
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>

<div id="map"></div>
<button id="toggle-routing-instructions">Mostrar Indicaciones</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    const map = L.map('map').setView([19.9124, -104.7263], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    const locationMarker = L.circleMarker([19.9124, -104.7263], {
        radius: 10,
        color: '#3388ff',
        weight: 2,
        fillColor: '#3388ff',
        fillOpacity: 0.5
    }).addTo(map);

    let routingControl = null;
    let destinationMarkers = [];
    let instructionsVisible = false;
    let hasZoomedToInitialLocation = false;
    let shouldZoomToRoute = false;
    let currentPosition = L.latLng([19.9124, -104.7263]);
    let autoGenerateRoute = false;
    let puntosFirebaseCargados = false;

    function setShouldGenerateRoute(value) {
        autoGenerateRoute = value;
        if (autoGenerateRoute && puntosFirebaseCargados) {
            shouldZoomToRoute = true;
            actualizarRuta();
        }
    }

    const btnToggleInstructions = document.getElementById('toggle-routing-instructions');
    btnToggleInstructions.onclick = () => {
        if (!routingControl) return;
        const container = routingControl.getContainer();
        if (!container) return;
        container.style.display = instructionsVisible ? 'none' : 'block';
        btnToggleInstructions.textContent = instructionsVisible ? 'Mostrar Indicaciones' : 'Ocultar Indicaciones';
        instructionsVisible = !instructionsVisible;
    };

    function traducirTexto(text) {
        const traducciones = [
            { en: 'Head', es: 'Dirígete' },
            { en: 'Turn right onto', es: 'Gira a la derecha en' },
            { en: 'Turn left onto', es: 'Gira a la izquierda en' },
            { en: 'Continue straight onto', es: 'Continúa recto en' },
            { en: 'You have arrived at your destination', es: 'Has llegado a tu destino' }
        ];
        for (const t of traducciones) {
            if (text.startsWith(t.en)) return text.replace(t.en, t.es);
        }
        return text;
    }

    function actualizarRuta() {
        if (!autoGenerateRoute || destinationMarkers.length === 0) return;
        const allPoints = [currentPosition, ...destinationMarkers.map(m => m.getLatLng())];

        if (routingControl) {
            routingControl.setWaypoints(allPoints);
            return;
        }

        routingControl = L.Routing.control({
            waypoints: allPoints,
            routeWhileDragging: false,
            addWaypoints: false,
            draggableWaypoints: false,
            showAlternatives: false,
            fitSelectedRoutes: false,
            createMarker: () => null,
            lineOptions: {
                styles: [{ color: 'blue', opacity: 0.7, weight: 5 }]
            },
            router: new L.Routing.OSRMv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            })
        }).addTo(map);

        routingControl.on('routesfound', function (e) {
            e.routes.forEach(route => {
                route.instructions.forEach(instruction => {
                    instruction.text = traducirTexto(instruction.text);
                });
            });

            const container = routingControl.getContainer();
            if (container) {
                container.style.display = instructionsVisible ? 'block' : 'none';
                btnToggleInstructions.style.display = 'block';
                btnToggleInstructions.textContent = instructionsVisible ? 'Ocultar Indicaciones' : 'Mostrar Indicaciones';
            }

            if (shouldZoomToRoute && e.routes.length > 0) {
                map.fitBounds(L.latLngBounds(e.routes[0].coordinates));
                shouldZoomToRoute = false;
            }
        });
    }

    function createDestinationMarker(latlng, nombre = "Destino", descripcion = "Sin descripción", url = "Sin URL", permitirEliminar = false) {
        const marker = L.marker(latlng);

        const popupContent = document.createElement('div');
        popupContent.innerHTML = `<strong>${nombre}</strong><br>${descripcion}`;

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'popup-actions';

        if (!permitirEliminar) {
            const infoBtn = document.createElement('button');
            infoBtn.textContent = 'Ver info';
            infoBtn.className = 'btn-info';
            infoBtn.onclick = () => alert(`Nombre: ${nombre}\nDescripción: ${descripcion}\nURL: ${url}`);
            actionsDiv.appendChild(infoBtn);
        }

        if (permitirEliminar) {
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '✖';
            deleteBtn.className = 'btn-delete';
            deleteBtn.onclick = () => {
                map.removeLayer(marker);
                destinationMarkers = destinationMarkers.filter(m => m !== marker);
                actualizarRuta();
            };
            actionsDiv.appendChild(deleteBtn);
        }

        if (actionsDiv.children.length > 0) {
            popupContent.appendChild(actionsDiv);
        }

        marker.bindPopup(popupContent);
        return marker;
    }

    function setInitialLocation(lat, lng) {
        currentPosition = L.latLng(lat, lng);
        locationMarker.setLatLng(currentPosition);
        if (!hasZoomedToInitialLocation) {
            map.setView(currentPosition, 17);
            hasZoomedToInitialLocation = true;
        }
        if (autoGenerateRoute && destinationMarkers.length > 0) {
            actualizarRuta();
        }
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                setInitialLocation(lat, lng);
            },
            (err) => console.error("Error de geolocalización", err),
            { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
        );
    }

    const firebaseConfig = {
        apiKey: "AIzaSyB2UazTvsuFFRP3_5oebq-IFewhlcykm8E",
        authDomain: "descubremastalpaproyec.firebaseapp.com",
        projectId: "descubremastalpaproyec",
        storageBucket: "descubremastalpaproyec.appspot.com",
        messagingSenderId: "334222818266",
        appId: "1:334222818266:android:ee97b5c4b51e571b0c9ee3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    db.collection("Lugares").get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const lat = parseFloat(data.Latitud);
            const lng = parseFloat(data.Longitud);
            if (!isNaN(lat) && !isNaN(lng)) {
                const marker = createDestinationMarker([lat, lng], data.Nombre, data.Descripcion, data.URL, false);
                marker.addTo(map);
                destinationMarkers.push(marker);
            }
        });

        puntosFirebaseCargados = true;
        if (autoGenerateRoute) {
            shouldZoomToRoute = true;
            actualizarRuta();
        }
    });

    map.on('click', function (e) {
        const latlng = e.latlng;
        const nombre = prompt("Ingresa un nombre para este destino:");
        if (nombre !== null && nombre.trim() !== "") {
            const marker = createDestinationMarker(latlng, nombre.trim(), "Manual", "Sin URL", true).addTo(map);
            destinationMarkers.push(marker);
            shouldZoomToRoute = true;
            actualizarRuta();
        }
    });
</script>

</body>
</html>