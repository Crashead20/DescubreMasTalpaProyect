<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Mapa con Ruta Manual</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        #toggle-routing-instructions {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #3388ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: none;
        }
        .leaflet-routing-container {
            top: 60px !important;
        }
    </style>
</head>
<body>

<div id="map"></div>
<button id="toggle-routing-instructions">Mostrar Indicaciones</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    const map = L.map('map').setView([19.9124, -104.7263], 17);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    const locationMarker = L.circleMarker([19.9124, -104.7263], {
        radius: 10,
        color: '#3388ff',
        weight: 2,
        fillColor: '#3388ff',
        fillOpacity: 0.5
    }).addTo(map);

    let routingControl = null;
    let destinationMarkers = [];
    let instructionsVisible = false;
    let hasZoomedToInitialLocation = false;
    let shouldZoomToRoute = false;
    let currentPosition = L.latLng([19.9124, -104.7263]);

    const btnToggleInstructions = document.getElementById('toggle-routing-instructions');

    btnToggleInstructions.onclick = () => {
        if (!routingControl) return;
        const container = routingControl.getContainer();
        if (!container) return;

        container.style.display = instructionsVisible ? 'none' : 'block';
        btnToggleInstructions.textContent = instructionsVisible ? 'Mostrar Indicaciones' : 'Ocultar Indicaciones';
        instructionsVisible = !instructionsVisible;
    };

    function traducirTexto(text) {
        const traducciones = [
            { en: 'Head northwest on', es: 'Dirígete hacia el noroeste por' },
            { en: 'Head northeast on', es: 'Dirígete hacia el noreste por' },
            { en: 'Head southwest on', es: 'Dirígete hacia el suroeste por' },
            { en: 'Head southeast on', es: 'Dirígete hacia el sureste por' },
            { en: 'Head east on', es: 'Dirígete hacia el este por' },
            { en: 'Head west on', es: 'Dirígete hacia el oeste por' },
            { en: 'Head north on', es: 'Dirígete hacia el norte por' },
            { en: 'Head south on', es: 'Dirígete hacia el sur por' },
            { en: 'Turn right onto', es: 'Gira a la derecha en' },
            { en: 'Turn left onto', es: 'Gira a la izquierda en' },
            { en: 'Continue straight onto', es: 'Continúa recto en' },
            { en: 'You have arrived at your destination', es: 'Has llegado a tu destino' },
        ];
        for (const t of traducciones) {
            if (text.startsWith(t.en)) {
                return text.replace(t.en, t.es);
            }
        }
        return text;
    }

    function actualizarRuta() {
        if (destinationMarkers.length === 0) return;
        const allPoints = [currentPosition, ...destinationMarkers.map(m => m.getLatLng())];

        if (routingControl) {
            routingControl.setWaypoints(allPoints);
            return;
        }

        routingControl = L.Routing.control({
            waypoints: allPoints,
            routeWhileDragging: false,
            addWaypoints: false,
            draggableWaypoints: false,
            showAlternatives: false,
            fitSelectedRoutes: false,
            createMarker: () => null,
            lineOptions: {
                styles: [{ color: 'blue', opacity: 0.7, weight: 5 }]
            },
            router: new L.Routing.OSRMv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            })
        }).addTo(map);

        routingControl.on('routesfound', function (e) {
            e.routes.forEach(route => {
                route.instructions.forEach(instruction => {
                    instruction.text = traducirTexto(instruction.text);
                });
            });

            const container = routingControl.getContainer();
            if (container) {
                container.style.display = instructionsVisible ? 'block' : 'none';
                btnToggleInstructions.style.display = 'block';
                btnToggleInstructions.textContent = instructionsVisible ? 'Ocultar Indicaciones' : 'Mostrar Indicaciones';
            }

            if (shouldZoomToRoute && e.routes.length > 0) {
                map.fitBounds(L.latLngBounds(e.routes[0].coordinates));
                shouldZoomToRoute = false;
            }
        });
    }

    function createDestinationMarker(latlng, nombre = "Destino", descripcion = "Sin descripción", url = "Sin URL") {
        const marker = L.marker(latlng, { draggable: false });

        const popupContent = document.createElement('div');
        popupContent.style.display = 'flex';
        popupContent.style.alignItems = 'center';

        const label = document.createElement('span');
        label.textContent = nombre;
        label.style.marginRight = '8px';

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.style.background = '#ff4d4d';
        deleteBtn.style.color = 'white';
        deleteBtn.style.border = 'none';
        deleteBtn.style.borderRadius = '3px';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.style.padding = '2px 6px';
        deleteBtn.onclick = () => {
            map.removeLayer(marker);
            destinationMarkers = destinationMarkers.filter(m => m !== marker);
            if (destinationMarkers.length === 0 && routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
                btnToggleInstructions.style.display = 'none';
                instructionsVisible = false;
            } else {
                shouldZoomToRoute = false;
                actualizarRuta();
            }
        };

        const infoButton = document.createElement('button');
        infoButton.textContent = 'Ver Info';
        infoButton.style.marginLeft = '8px';
        infoButton.onclick = () => {
            if (typeof Android !== 'undefined' && Android.showInfo) {
                Android.showInfo(nombre, descripcion, url);
            } else {
                alert(nombre + '\n' + descripcion);
            }
        };

        popupContent.appendChild(label);
        popupContent.appendChild(deleteBtn);
        popupContent.appendChild(infoButton);

        marker.bindPopup(popupContent);
        return marker;
    }

    function setInitialLocation(lat, lng) {
        currentPosition = L.latLng(lat, lng);
        locationMarker.setLatLng(currentPosition);

        if (!hasZoomedToInitialLocation) {
            map.setView(currentPosition, 17);
            hasZoomedToInitialLocation = true;
        }

        if (destinationMarkers.length > 0) {
            actualizarRuta();
        }
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                setInitialLocation(lat, lng);
            },
            (err) => {
                console.error("Error obteniendo ubicación", err);
            },
            { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
        );
    }

    // Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyB2UazTvsuFFRP3_5oebq-IFewhlcykm8E",
        authDomain: "descubremastalpaproyec.firebaseapp.com",
        projectId: "descubremastalpaproyec",
        storageBucket: "descubremastalpaproyec.appspot.com",
        messagingSenderId: "334222818266",
        appId: "1:334222818266:android:ee97b5c4b51e571b0c9ee3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Mostrar marcadores de Firebase sin generar rutas ----------------------
    db.collection("Lugares").get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const lat = parseFloat(data.Latitud);
            const lng = parseFloat(data.Longitud);
            if (!isNaN(lat) && !isNaN(lng)) {
                const marker = createDestinationMarker([lat, lng], data.Nombre, data.Descripcion, data.URL);
                marker.addTo(map); // solo se agrega, no se añade a ruta
            }
        });
    });

    // Click en el mapa para agregar puntos con ruta
    map.on('click', function (e) {
        const latlng = e.latlng;
        const marker = createDestinationMarker(latlng).addTo(map);
        destinationMarkers.push(marker);
        shouldZoomToRoute = true;
        actualizarRuta();
    });
</script>

</body>
</html>
